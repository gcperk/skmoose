---
title: "Moose_survey"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Moose_survey}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, eval=FALSE}
library(skmoose)
library(sf)
library(dplyr)
library(terra)

```

# Introduction

This package assists in determining moose quality and extent of usable habitat for a given study area. 

Read in the survey blocks file. We will use a test subset provided with the package as an example. Note this file is preffered to be in .gpkg format, however see below for an example of converting a .shp to .gpkg file. 

```{r}

# read in the data 

data_location <- fs::path_package("extdata", package = "skmoose")
data_file <- skmoose::skmoose_example()
bks_name <- file.path(data_location, data_file)


# read in and format the data 
aoi <- sf::st_read(file.path(bks_name))
aoi <- aoi %>%
  dplyr::mutate(bkname = seq(1,length(aoi$Name), 1)) %>%
  dplyr::select(bkname)%>%
  st_zm()


# simplify the blocks into a single polygon to extract for the entire area. 
aoi_simple <- st_union(aoi)

```

Create an ouput folder where you want the raw data geospatial data to be saved. 

```{r}

out_dir <- "C:\\Users\\genev\\OneDrive\\Documents\\02.Contracts\\2023_oddjobs\\2023_moose_block_surveyR\\02.Data\\data"


if (!dir.exists(out_dir )){
  dir.create(out_dir )
}else{
  print("dir exists")
}


```

```{r}
# extract all base data

get_basedata(in_aoi = aoi_simple, out_path = out_dir)


```

Once all the base data is extracted we can filter uninhabitable areas for moose. 
This includes : 

- Rock and Ice 
- Waterbodies >1 km2
- Elevations >1500 m 
- Slopes >55 degrees


```{r}
# 1. extract rock and ice areas

rockice <- st_read(file.path(out_dir, "vri.gpkg")) %>%
  dplyr::filter(BCLCS_LEVEL_3 == "A") %>%
  dplyr::select(id) %>%
  st_union()%>%
  st_cast("MULTIPOLYGON")

sf::st_write(rockice, file.path(out_dir, "rockice.gpkg"))


# 2. filter lakes with >1 km2

largelakes <- st_read(file.path(out_dir, "lakes.gpkg")) %>%
  dplyr::filter(AREA_HA > 1000) %>%
  st_union()

st_write(largelakes , file.path(out_dir, "high_elevation.gpkg"))


# 3. filter elevations above threshold value

eval_threshold = 1500

trim <- terra::rast(file.path(out_dir, "dem.tif"))
high_elev_sf <- high_elev(trim, eval_threshold )

st_write(high_elev_sf , file.path(out_dir, "high_elevation.gpkg"))


# 4. filter high slope 

slope_threshold = 55

 steep_sf <- steep_slope(trim, slope_threshold)

 st_write(steep_sf, file.path(out_dir, "steep.gpkg"))



 
 # compine uninhabited areas for moose

unhab <- st_intersection(rockice, high_elev_sf, steep_sf, largelakes)

unhab <- unhab %>% st_union()


```



We now compiled all the moose habitat areas 
This includes : 
- Deciduous tree species, queried in VRI: [SPECIES_CD LIKE 'A%' OR SPECIES_CD = 'EP' OR SPECIES_CD = 'SB' OR SPECIES__1 LIKE 'A%' OR SPECIES__1 = 'EP' OR SPECIES__1 = 'SB' OR SPECIES__3 LIKE 'A%' OR SPECIES__3 = 'EP' OR SPECIES__3 ='SB' OR SPECIES__5 LIKE 'A%' OR SPECIES__5 LIKE 'E%']

- Early seral/shrub dynamic habitats: Fires that are >5 and <40 years old 
** this one I might have to think about a bit more as basically the entire study area has burnt in 2014, 2018, 2021 or 2023. In 2018 we created a 4th stratum called Burnt so may look at potentially completed this again.

o	Cutblocks that are >5 and < 40 years old 
o	Buffered 3-8 order streams from FWA stream dataset by 150m (dissolved) 
o	9th order streams buffered by 500 meters. 
o	Wetlands from FWA â‰¤ 1 km2
o	Skeena Wildlife Ecological Resource Model- Winter forage output 



```{r}

# get deciduous leading species

    vri <- st_read(file.path(out_dir, "vri.gpkg"))
    species_codes = c("AT", "AC","EP","SB")
    decid <- vri_browse(vri, species_codes)

    st_write(decid , file.path(out_dir, "vri_decid.gpkg") , append = FALSE)

  

 # get recent harvest 
  cutblocks <- st_read(file.path(out_dir, "cutblocks.gpkg"))
  cutblocks_yrs <- cutblocks_recent(cutblocks, cutblock_min_yr = 5, cutblock_max_yr = 40)
 
  st_write(cutblocks_yrs, file.path(out_dir, "cutblocks_filtered.gpkg"), append = FALSE)


  
  # get recent fire years 

  
  fires <- st_read(file.path(out_dir, "fire.gpkg"))
  fires_filtered <- fires_recent(fires, fire_min_yr = 5, fire_max_yr = 40 )
  
  st_write(fires, file.path(out_dir, "fires_filtered.gpkg"), append = FALSE)
  
  # get stream order and buffer by stream order, stream order 3 - 8 is 150m buffer, stream order 9 bufferd by 500m 
  
# Buffered 3-8 order streams from FWA stream dataset by 150m (dissolved) 
#- 9th order streams buffered by 500 meters. 
  
    stream38 <- st_read(file.path(out_dir, "streams.gpkg")) %>% 
      dplyr::filter(STREAM_ORDER %in% c(3,4,5,6,7,8))%>%
      sf::st_buffer(150) %>%
      sf::st_union()

  stream9 <- st_read(file.path(out_dir, "streams.gpkg")) %>% 
      dplyr::filter(STREAM_ORDER == 9) %>%
      sf::st_buffer(500) %>%
      sf::st_union()
  
  
  
  # wetlands 
  
   wetlands <- st_read(file.path(out_dir, "wetlands.gpkg")) 
      dplyr::filter(AREA_HA <= 1000) %>%
      sf::st_buffer(500) %>%
      sf::st_union()

  st_write(wetlands, file.path(out_path, "wetland_filter.gpkg"), append = FALSE)


  
  
  #Skeena Wildlife Ecological Resource Model- Winter forage output 
  
  
  
  
  

```

